<!DOCTYPE html>  <html> <head>   <title>app.feellondon.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.feellondon.html">                 app.feellondon.js               </a>                                           <a class="source" href="jade-middleware.html">                 jade-middleware.js               </a>                                           <a class="source" href="linked-list.html">                 linked-list.js               </a>                                           <a class="source" href="live-reload.html">                 live-reload.js               </a>                                           <a class="source" href="middleware.html">                 middleware.js               </a>                                           <a class="source" href="redis-set-storage.html">                 redis-set-storage.js               </a>                                           <a class="source" href="redis-timeseries-storage.html">                 redis-timeseries-storage.js               </a>                                           <a class="source" href="router.html">                 router.js               </a>                                           <a class="source" href="twitter-at-client.html">                 twitter-at-client.js               </a>                                           <a class="source" href="ws-repeater.html">                 ws-repeater.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.feellondon.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Application for Nike/H&amp;L Project Victory</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Setup</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Module Dependencies.</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lessMiddleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;less-middleware&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">argv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;optimist&#39;</span><span class="p">).</span><span class="nx">argv</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Custom Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">jadeMiddleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/jade-middleware.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">corsMiddleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/cors-middleware.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">liveReload</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/live-reload.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">WebSocketRepeater</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/ws-repeater.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">TwitterAtClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/twitter-at-client.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">RedisSetStorage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/redis-set-storage.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">RedisTimeseriesStorage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/redis-timeseries-storage.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">TwitterMiddleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/middleware.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/router.js&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">MockTweetList</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;libs/mock-tweet-list.js&#39;</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>DB / Redis</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Use data base 3</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">redisClient</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Container for bad words</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">badWordsStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisSetStorage</span><span class="p">({</span>
    <span class="nx">redisClient</span><span class="o">:</span> <span class="nx">redisClient</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;badwords&quot;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Container for banned usernames</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">bannedUsersStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisSetStorage</span><span class="p">({</span>
    <span class="nx">redisClient</span><span class="o">:</span> <span class="nx">redisClient</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;badusers&quot;</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">hashTagTimeseriesStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">({</span>
    <span class="nx">redisClient</span><span class="o">:</span> <span class="nx">redisClient</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;h&quot;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Dev Tweets lists</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">mockTweetList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockTweetList</span><span class="p">({</span>
    <span class="nx">redisClient</span><span class="o">:</span> <span class="nx">redisClient</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Utils</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Returns the set of bad updating it 
periodically to save query the bad words 
every tweet</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">getBadWords</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">badWords</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">lastUpdated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">updateEveryMS</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">lastUpdated</span> <span class="o">&gt;</span> <span class="nx">updateEveryMS</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">badWordsStorage</span><span class="p">.</span><span class="nx">getItems</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">badWords</span> <span class="o">=</span> <span class="nx">items</span><span class="p">;</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">badWords</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">badWords</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}());</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h1>HTML Server</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Options</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">serveFromDirectory</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">d</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public/&#39;</span><span class="p">)</span> <span class="p">);</span>
<span class="kd">var</span> <span class="nx">shouldWatchFiles</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LIVE_RELOAD</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">l</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">livereload</span><span class="p">;</span> </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>legacy</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">shouldWatchFiles</span> <span class="o">=</span> <span class="nx">shouldWatchFiles</span> <span class="o">||</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">WATCH</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">w</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">watch</span><span class="p">;</span> 

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">p</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">jadeOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">pretty</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">basedir</span><span class="o">:</span> <span class="nx">serveFromDirectory</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">jadeLayoutFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">serveFromDirectory</span><span class="p">,</span> <span class="s1">&#39;layout.jade&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span> <span class="nx">jadeLayoutFile</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">jadeOptions</span><span class="p">.</span><span class="nx">filename</span> <span class="o">=</span> <span class="nx">jadeLayoutFile</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">jadeMiddleware</span><span class="p">({</span>
        <span class="nx">src</span><span class="o">:</span> <span class="nx">serveFromDirectory</span><span class="p">,</span>
        <span class="nx">jadeOptions</span><span class="o">:</span> <span class="nx">jadeOptions</span>
    <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">lessMiddleware</span><span class="p">({</span>
        <span class="nx">src</span><span class="o">:</span> <span class="nx">serveFromDirectory</span>
    <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">serveFromDirectory</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">directory</span><span class="p">(</span><span class="nx">serveFromDirectory</span><span class="p">));</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>Routing</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h4>Cors support</h4>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nx">corsMiddleware</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h4>Bad words list</h4>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/bad-words/&#39;</span><span class="p">,</span> <span class="nx">badWordsStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/bad-words/&#39;</span><span class="p">,</span> <span class="nx">badWordsStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">add</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/bad-words/&#39;</span><span class="p">,</span> <span class="nx">badWordsStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="k">delete</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h4>Banned users list</h4>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/banned-users/&#39;</span><span class="p">,</span> <span class="nx">bannedUsersStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/banned-users/&#39;</span><span class="p">,</span> <span class="nx">bannedUsersStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">add</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/banned-users/&#39;</span><span class="p">,</span> <span class="nx">bannedUsersStorage</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="k">delete</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h4>Hashtag counter</h4>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hashtags/:tag/&#39;</span><span class="p">,</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_MINUTE</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hashtags/:tag/minute/&#39;</span><span class="p">,</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_MINUTE</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hashtags/:tag/hour/&#39;</span><span class="p">,</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_HOUR</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hashtags/:tag/day/&#39;</span><span class="p">,</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_DAY</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hashtags/:tag/week/&#39;</span><span class="p">,</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_WEEK</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h4>Dev tweet list</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Returns the lastest dev tweets</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/mock-tweet-list/&#39;</span><span class="p">,</span> <span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/mock-tweet-list/&#39;</span><span class="p">,</span> <span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">post</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/mock-tweet-list/:tweetId/&#39;</span><span class="p">,</span> <span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="k">delete</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/mock-tweet-list/trigger/:tweetId/&#39;</span><span class="p">,</span> <span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">trigger</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Store the last triggered tweets</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">triggerTweets</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;triggered&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">triggerTweets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tweet</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Returns the last triggered tweets since last request</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/mock-tweet-list/triggered/&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">triggerTweets</span><span class="p">);</span>
    <span class="nx">triggerTweets</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getHashTagRequestHander</span><span class="p">(</span><span class="nx">resolution</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hashTagTimeseriesStorage</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">resolution</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h1>Web Socket Server</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Create the web socket server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">websocketServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketRepeater</span><span class="p">({</span>
    <span class="nx">server</span><span class="o">:</span> <span class="nx">server</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h1>Twitter Flow</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">twitterMiddleware</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwitterMiddleware</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>Logout the tweet</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tweet</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2>Check for banned users</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bannedUsersStorage</span><span class="p">.</span><span class="nx">hasItem</span><span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">userScreenName</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error: error checking if twitter user exits&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Banned user tweeting&quot;</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>Count hash tags</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tweet</span><span class="p">.</span><span class="nx">hashTags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">hashTag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hashTagTimeseriesStorage</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="nx">hashTag</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>Check for commands</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>Check for shout out</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">twitterMiddleware.add(function (tweet, next) {</span>
<span class="cm">    var i = 0;</span>
<span class="cm">    var hasShoutout = false;</span>
<span class="cm">    while (i &lt; tweet.hashTags.length &amp;&amp; !hasShoutout) {</span>
<span class="cm">        if (tweet.hashTags[i].text === &quot;shoutout&quot;) {</span>
<span class="cm">            hasShoutout = true;</span>
<span class="cm">        }</span>
<span class="cm">        ++i;</span>
<span class="cm">    }</span>
<span class="cm">    if (hasShoutout) {</span>
<span class="cm">        next();</span>
<span class="cm">    }</span>
<span class="cm">});</span>
<span class="cm">*/</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h2>Check for bad words</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">getBadWords</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">badWords</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">hasBadWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">badWords</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasBadWord</span><span class="p">)</span> <span class="p">{</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">badWords</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">hasBadWord</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="o">++</span><span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasBadWord</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h2>Store tweet</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">storeTweet</span><span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Problem storing tweet&#39;</span><span class="p">);</span> 
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h2>Broadcast tweet</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sendModerationTweet</span><span class="p">(</span><span class="s1">&#39;initial&#39;</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h1>Websocket listener / router</h1>

<p>Perhaps this should be moved to a seperate client</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">wsRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>

<span class="nx">wsRouter</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;/moderation/initial/approved/:tweetId/&#39;</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">retrieveTweetWithId</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">tweetId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendModerationTweet</span><span class="p">(</span><span class="s1">&#39;legal&#39;</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;/moderation/legal/approved/:tweetId/&#39;</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">retrieveTweetWithId</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">tweetId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Could not retrieve tweet with retrieveTweetWithId for id&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">tweetId</span><span class="p">);</span>
            <span class="p">}</span>
           <span class="nx">sendShoutout</span><span class="p">(</span><span class="nx">tweet</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>

<span class="nx">websocketServer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">resource</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">json</span><span class="p">.</span><span class="nx">resource</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wsRouter</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">json</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h1>Utils</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">storeTweet</span><span class="p">(</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">str</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tweet</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error jsonifying tweet&#39;</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Store in redis</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;tweets:&#39;</span><span class="o">+</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="p">);</span> <span class="c1">// 7 weeks</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">retrieveTweetWithId</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tweets:&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tweetAsString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Try JSON it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">tweet</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">tweet</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">tweetAsString</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h2>Broadcast messages</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">sendModerationTweet</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">moderationMessage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">resource</span> <span class="o">:</span> <span class="s2">&quot;/moderation/&quot;</span><span class="o">+</span><span class="nx">level</span><span class="o">+</span><span class="s2">&quot;/new/&quot;</span><span class="p">,</span>
        <span class="nx">method</span> <span class="o">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
        <span class="nx">body</span> <span class="o">:</span> <span class="nx">tweet</span>
    <span class="p">};</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">moderationMessage</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error jsonifying moderation message&#39;</span><span class="p">,</span> <span class="nx">moderationMessage</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="nx">websocketServer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sendShoutout</span><span class="p">(</span><span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">moderationMessage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">resource</span> <span class="o">:</span> <span class="s2">&quot;/shoutout/new/&quot;</span><span class="p">,</span>
        <span class="nx">body</span> <span class="o">:</span> <span class="nx">tweet</span>
    <span class="p">};</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">moderationMessage</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error jsonifying moderation message&#39;</span><span class="p">,</span> <span class="nx">moderationMessage</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="nx">websocketServer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h1>Twitter Stream Connect</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">twitterAtClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwitterAtClient</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Connect the router up to the steaming twitter client </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twitterAtClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;tweet&#39;</span><span class="p">,</span> <span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">route</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Connect the router up to the mock tweet system</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">mockTweetList</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;triggered&#39;</span><span class="p">,</span> <span class="nx">twitterMiddleware</span><span class="p">.</span><span class="nx">route</span> <span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h1>Live Reloading</h1>

<p>To watch <code>WATCH=1 node app.js</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">shouldWatchFiles</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">liveReload</span><span class="p">.</span><span class="nx">watch</span><span class="p">({</span>
        <span class="nx">pathPatterns</span><span class="o">:</span> <span class="p">[</span><span class="nx">serveFromDirectory</span><span class="o">+</span><span class="s2">&quot;/**/*&quot;</span><span class="p">],</span>
        <span class="nx">server</span><span class="o">:</span> <span class="nx">server</span><span class="p">,</span>
        <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">lcyan</span><span class="p">(</span><span class="s2">&quot;Servant&quot;</span><span class="p">,</span> <span class="s2">&quot;serving&quot;</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">bold</span><span class="p">(</span><span class="s2">&quot;\n   &quot;</span> <span class="o">+</span> <span class="nx">serveFromDirectory</span><span class="p">)</span> <span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nfrom port:&quot;</span><span class="p">,</span>  <span class="nx">green</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">))</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">shouldWatchFiles</span><span class="p">)</span> <span class="p">{</span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&quot;whilst watching for file changes.\nadd&quot;</span><span class="p">,</span> <span class="nx">lcyan</span><span class="p">(</span><span class="s2">&quot;`/watch.js`&quot;</span><span class="p">),</span> <span class="s2">&quot; to your html for live reloading.&quot;</span> <span class="p">);</span> <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Bit of color</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">green</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;\033[1;32m&quot;</span> <span class="o">+</span>  <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\033[0m&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">green</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;\033[1;32m&quot;</span> <span class="o">+</span>  <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\033[0m&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">lcyan</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;\033[1;36m&quot;</span> <span class="o">+</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\033[0m&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bold</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;\033[1m&quot;</span> <span class="o">+</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\033[0m&quot;</span><span class="p">;</span> <span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 