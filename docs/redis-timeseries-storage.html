<!DOCTYPE html>  <html> <head>   <title>redis-timeseries-storage.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.feellondon.html">                 app.feellondon.js               </a>                                           <a class="source" href="jade-middleware.html">                 jade-middleware.js               </a>                                           <a class="source" href="linked-list.html">                 linked-list.js               </a>                                           <a class="source" href="live-reload.html">                 live-reload.js               </a>                                           <a class="source" href="middleware.html">                 middleware.js               </a>                                           <a class="source" href="redis-set-storage.html">                 redis-set-storage.js               </a>                                           <a class="source" href="redis-timeseries-storage.html">                 redis-timeseries-storage.js               </a>                                           <a class="source" href="router.html">                 router.js               </a>                                           <a class="source" href="twitter-at-client.html">                 twitter-at-client.js               </a>                                           <a class="source" href="ws-repeater.html">                 ws-repeater.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               redis-timeseries-storage.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Stores counts of a list of values.</p>

<p>Keys are stored at the following resolution:</p>

<ul>
<li>minutes for the 120 minutes</li>
<li>hours for the 120 hours</li>
<li>days for the last 120 days</li>
<li>weeks for the last 120 weeks</li>
</ul>

<p>The storage is time independant in that key counts are not expressed in "from date" and "to date" but "from time ago" to "time ago". This avoid server and request time differences.</p>

<p>Next idea.... set up caching, so that once a day has pass, the minutes are stored in a cache of arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2> Config</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">MAX_KEYS</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2> Time Utilites</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Reference date.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">EPOCH</span> <span class="o">=</span> <span class="mi">1379425660487</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Seconds.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">SECS_PER_MIN</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">SECS_PER_HOUR</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">SECS_PER_MIN</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">SECS_PER_DAY</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="nx">SECS_PER_HOUR</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">SECS_PER_WEEK</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="nx">SECS_PER_DAY</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Milliseconds.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">MS_PER_SEC</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MS_PER_MIN</span> <span class="o">=</span> <span class="nx">SECS_PER_MIN</span> <span class="o">*</span> <span class="nx">MS_PER_SEC</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MS_PER_HOUR</span> <span class="o">=</span> <span class="nx">SECS_PER_HOUR</span> <span class="o">*</span> <span class="nx">MS_PER_SEC</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MS_PER_DAY</span> <span class="o">=</span> <span class="nx">SECS_PER_DAY</span> <span class="o">*</span> <span class="nx">MS_PER_SEC</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MS_PER_WEEK</span> <span class="o">=</span> <span class="nx">SECS_PER_WEEK</span> <span class="o">*</span> <span class="nx">MS_PER_SEC</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getMinutesSinceEpoch</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">EPOCH</span><span class="p">)</span> <span class="o">/</span> <span class="nx">MS_PER_MIN</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getHoursSinceEpoch</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">EPOCH</span><span class="p">)</span> <span class="o">/</span> <span class="nx">MS_PER_HOUR</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getDaysSinceEpoch</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">EPOCH</span><span class="p">)</span> <span class="o">/</span> <span class="nx">MS_PER_DAY</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getWeeksSinceEpoch</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">EPOCH</span><span class="p">)</span> <span class="o">/</span> <span class="nx">MS_PER_WEEK</span> <span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Redis incrementors</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Main function to increment a key.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">increment</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">amount</span> <span class="o">!==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;increment amount is not number&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Chain each redis command.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">incrementMinute</span><span class="p">(</span><span class="nx">multi</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
    <span class="nx">incrementHour</span><span class="p">(</span><span class="nx">multi</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
    <span class="nx">incrementDays</span><span class="p">(</span><span class="nx">multi</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
    <span class="nx">incrementWeeks</span><span class="p">(</span><span class="nx">multi</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Do it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">incrementMinute</span><span class="p">(</span><span class="nx">redisMutli</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullKey</span> <span class="o">=</span> <span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;m:&quot;</span><span class="o">+</span><span class="nx">getMinutesSinceEpoch</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">amount</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span> <span class="nx">fullKey</span> <span class="p">);</span> <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incrby</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">);</span> <span class="p">}</span>
    <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">SECS_PER_MIN</span> <span class="o">*</span> <span class="nx">MAX_KEYS</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">incrementHour</span><span class="p">(</span><span class="nx">redisMutli</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullKey</span> <span class="o">=</span> <span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;h:&quot;</span><span class="o">+</span><span class="nx">getHoursSinceEpoch</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">amount</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span> <span class="nx">fullKey</span> <span class="p">);</span> <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incrby</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">);</span> <span class="p">}</span>
    <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">SECS_PER_HOUR</span> <span class="o">*</span> <span class="nx">MAX_KEYS</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">incrementDays</span><span class="p">(</span><span class="nx">redisMutli</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullKey</span> <span class="o">=</span> <span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;d:&quot;</span><span class="o">+</span><span class="nx">getDaysSinceEpoch</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">amount</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span> <span class="nx">fullKey</span> <span class="p">);</span> <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incrby</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">);</span> <span class="p">}</span>
    <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">SECS_PER_DAY</span> <span class="o">*</span> <span class="nx">MAX_KEYS</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">incrementWeeks</span><span class="p">(</span><span class="nx">redisMutli</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullKey</span> <span class="o">=</span> <span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;w:&quot;</span><span class="o">+</span><span class="nx">getWeeksSinceEpoch</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">amount</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span> <span class="nx">fullKey</span> <span class="p">);</span> <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span> <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">incrby</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">);</span> <span class="p">}</span>
    <span class="nx">redisMutli</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">fullKey</span><span class="p">,</span> <span class="nx">SECS_PER_WEEK</span> <span class="o">*</span> <span class="nx">MAX_KEYS</span> <span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Redis getters</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">countMinutes</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span>  <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">currentTimeKey</span> <span class="o">=</span> <span class="nx">getMinutesSinceEpoch</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">currentTimeKey</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">currentTimeKey</span><span class="o">-</span><span class="nx">MAX_KEYS</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;m:&quot;</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">countHours</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span>  <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">currentTimeKey</span> <span class="o">=</span> <span class="nx">getHoursSinceEpoch</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">currentTimeKey</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">currentTimeKey</span><span class="o">-</span><span class="nx">MAX_KEYS</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;h:&quot;</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">countDays</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span>  <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">currentTimeKey</span> <span class="o">=</span> <span class="nx">getDaysSinceEpoch</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">currentTimeKey</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">currentTimeKey</span><span class="o">-</span><span class="nx">MAX_KEYS</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;d:&quot;</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">countWeeks</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span>  <span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">currentTimeKey</span> <span class="o">=</span> <span class="nx">getWeeksSinceEpoch</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">currentTimeKey</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">currentTimeKey</span><span class="o">-</span><span class="nx">MAX_KEYS</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyPrepend</span><span class="o">+</span><span class="s2">&quot;w:&quot;</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>RedisTimeseriesStorage</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">RedisTimeseriesStorage</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span> <span class="o">=</span> <span class="s2">&quot;js:tss:&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span> <span class="o">+=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>resolutions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_MINUTE</span>   <span class="o">=</span> <span class="s2">&quot;minute&quot;</span><span class="p">;</span>
<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_HOUR</span>     <span class="o">=</span> <span class="s2">&quot;hour&quot;</span><span class="p">;</span>
<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_DAY</span>      <span class="o">=</span> <span class="s2">&quot;day&quot;</span><span class="p">;</span>
<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_WEEK</span>     <span class="o">=</span> <span class="s2">&quot;week&quot;</span><span class="p">;</span>

<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">increment</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">increment</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">incrementBy</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">increment</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">resolution</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">resolution</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_MINUTE</span><span class="o">:</span>
            <span class="nx">countMinutes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_HOUR</span><span class="o">:</span>
            <span class="nx">countHours</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_DAY</span><span class="o">:</span>
            <span class="nx">countDays</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">.</span><span class="nx">RES_WEEK</span><span class="o">:</span>
            <span class="nx">countWeeks</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyPrepend</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;RedisTimeseriesStorage::count Error: no resolution provided&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Export</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">RedisTimeseriesStorage</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 